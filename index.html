<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>Course Comparison Tool</title>
   
    <!-- Bootstrap Styling -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap.min.css">

    <!-- Custom Styling -->
    <link rel="stylesheet" href="css/main.css">

    <!-- Load JavaScript libraries -->
    <script src="http://d3js.org/d3.v3.min.js"></script>
    <script src="http://d3js.org/queue.v1.min.js"></script>
    <script src="https://code.jquery.com/jquery-2.1.3.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/js/bootstrap.min.js"></script>
    <script src="http://twitter.github.io/typeahead.js/releases/latest/typeahead.bundle.min.js"></script>
    <script src="https://jquery-csv.googlecode.com/files/jquery.csv-0.71.js"></script>
  </head>
  <body>
    <div class="container-fluid header">
      <div class="container">
        <div class="row space">
          <div class="col-md-3">
            <h3>UW Course Comparison</h3>
          </div>
          <div class="col-md-3">
            <div class="class-1-box">
              <input class="typeahead form-control class-1" type="search" placeholder="Enter Course 1">
            </div>
          </div>
          <div class="col-md-3">
            <div class="class-2-box">
              <input class="typeahead form-control class-2" type="search" placeholder="Enter Course 2">
            </div>
          </div>
          <div class="col-md-3">
            <div class="class-3-box">
              <input class="typeahead form-control class-3" type="search" placeholder="Enter Course 3">
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="space">
      <label><input type="checkbox" id="optionSort"> Sort Features</label>
    </div>
    <div class="container graph">
    </div>
  </body>
  <script>

// Graph size and coordinates
var margin = {top: 90, right: 10, bottom: 10, left: 150},
    width = 960 - margin.left - margin.right,
    height = 500 - margin.top - margin.bottom;

var x = d3.scale.ordinal().rangePoints([0, width], 1),
    y = {};

var line = d3.svg.line(),
    axis = d3.svg.axis().orient('left');

// Selected class colors: red, blue, green
var colors = ['#e41a1c', '#377eb8', '#4daf4a'];

var likertTicks = ['very poor', 'poor', 'fair', 'good', 'very good', 'excellent'];

// Main svg container for graph
var svg = d3.select('.graph').append('svg')
    .attr('width', width + margin.left + margin.right)
    .attr('height', height + margin.top + margin.bottom)
  .append('g')
    .attr('transform', 'translate(' + margin.left + ',' + margin.top + ')');

// Separate yAxis on left to show Likert ratings
var yAxis = d3.svg.axis()
  .scale(
    d3.scale.linear()
      .range([height, 0]))
  .orient('left')
  .ticks(likertTicks.length)
  .tickFormat(function(_, i) { return likertTicks[i]; });
 
// Hover tooltip to show class name
var tooltip = d3.select('body')
  .append('div')
  .style('position', 'absolute')
  .style('z-index', '10')
  .style('visibility', 'hidden');

// Load the data files
queue()
  .defer(d3.csv, 'data/some_courses.csv')
  .defer(d3.json, 'data/eval_questions.json')
  .await(ready);

// Main sequence
function ready(error, courses, eval_questions) {
  // Extract the list of dimensions and create a scale for each.
  var features = d3.keys(courses[0]).filter(function(d) {
    // Exclude these features from the graph
    nonfeatures = ['crsabbr','crsno','fname','lname','formtype', 
                   'q23','q24','q25','q26','q27','q28','q29','q30','q31','q32'];
    return nonfeatures.indexOf(d) < 0 && 
      (y[d] = d3.scale.linear()
        .domain([0,5])
        .range([height, 0]));
  });

  x.domain(dimensions = features);

  // console.log(courses);
  // console.log(eval_questions);

  // Add a text description field to the courses objects. Used for typeahead text.
  var coursesDescriptions = [];
  for(var i in courses) {
    coursesDescriptions.push(courses[i].crsabbr + ' ' + courses[i].crsno + ' ' + courses[i].lname);
  }

  // Typeahead Form settings
  var typeaheadOptions = {
      hint: true,
      highlight: true,
      minLength: 1
    };
  
  // 3 typeahead forms distinguished by names 1-3
  $('input.class-1').typeahead(typeaheadOptions,
    {
      name: 1,
      displayKey: 'value',
      source: substringMatcher(coursesDescriptions)
    });
  $('input.class-2').typeahead(typeaheadOptions,
    {
      name: 2,
      displayKey: 'value',
      source: substringMatcher(coursesDescriptions)
    });
  $('input.class-3').typeahead(typeaheadOptions,
    {
      name: 3,
      displayKey: 'value',
      source: substringMatcher(coursesDescriptions)
    });

  // Typeahead event behavior; same for all 3
  $('input').on('typeahead:selected typeahead:autocompleted',
    // When the form is selected we get the text and which form it came from
    function(e, classSelection, inputIndex) {
      // Find the index of the string in the courses array
      var classIndex = coursesDescriptions.indexOf(classSelection.value);
      // Update that particular line
      updateLine(courses, classIndex, inputIndex);
    });

  // Insert the yAxis
  svg.append('g')
    .attr("class", "y axis")
    .attr('transform', 'translate(-15,0)')
    .call(yAxis);

  // Add a group element for each dimension (eval question).
  var g = svg.selectAll('.dimension')
      .data(dimensions)
    .enter().append('g')
      .attr('class', 'dimension')
      .attr('transform', function(d) { return 'translate(' + x(d) + ')'; });

  // Add an axis and title.
  g.append('g')
      .attr('class', 'axis feature-column')
      .each(function(d) { 
        that = d3.select(this);
        d3.select(this).call(axis.scale(y[d]));
        // No labels on columns
        that.call(axis.ticks(0));
        that.call(axis.tickFormat(''));
      })
    .append('text')
      .style('text-anchor', 'left')
      .attr('class','labels')
      .attr('x', 10)
      .attr('y', -10)
      .attr('transform', function(d) {
         return 'rotate(-45)'; 
      })
      .text(function(d, i) {
        return eval_questions[i].tag; 
      });

  // Format axis labels for likert ratings
  svg.selectAll('g.tick text')
    .attr('class','labels-ratings')
    .attr('x', -10);

  // Add group for each possible selection
  svg.selectAll('g.line')
    .data([1,2,3])
    .enter().append('g')
      .attr('class', function(d,i) { return 'line class-' + (i+1); })
    // Add an empty path that will be updated later
    .append('path');

  // Add empty circles that will be updated later
  svg.selectAll('g.line').each(function(d) {
    d3.select(this).selectAll('circle')
      .data(x.domain())
      .enter().append('circle');
    });

  d3.select('#optionSort')
    .on('change', function(_) { change(courses[1], features); });
}

// Called whenever a dropdown class selection changes
function updateLine(courses, classIndex, inputIndex) {

  var newClass = courses[classIndex];
  var lineGroup = svg.selectAll('g.class-' + inputIndex);

  // Update the line path
  lineGroup.selectAll('path')
    .data([newClass])
    .attr('d', path)
    .attr('stroke', function(d, i) { return colors[i]; })
    .style("stroke-opacity", 0.4)
    .on('mouseover', function(d){
      return tooltip
        .style('visibility', 'visible')
        .text(d.crsabbr + ' ' + d.crsno + ' ' + d.lname);
      })
    .on('mousemove', function(){
      return tooltip
        .style('top', (event.pageY-10)+'px').style('left',(event.pageX+10)+'px');
      })
    .on('mouseout', function(){
      return tooltip
        .style('visibility', 'hidden');
      });

  // Update the circles
  var circleCoords = points(newClass);
  lineGroup.selectAll('circle')
    .data(circleCoords)
    .attr('class', function(_,i) { return 'q' + i; })
    .attr('fill', function(_, i) { return colors[i]; })
    .attr('cx', function (d) { return d[0]; })
    .attr('cy', function (d) { return d[1]; })
    .attr('r', 5); 
}

// Sort the feature columns by value (Not working yet)
function change(course, features) {
  var checked = d3.select('#optionSort').property('checked');
  // Copy-on-write since tweens are evaluated after a delay.
  x0 = x.domain(checked?
    features.slice(0).sort(function(a, b) { return course[b] - course[a]; }) : dimensions = features)
    .copy();

  console.log(checked);
  console.log(course);
  console.log(features);

  var transition = svg.transition().duration(750);
  var delay = function(d, i) { return i * 50; };

  //svg.selectAll('circle')
  //  .sort(function(a, b) { return x(a) - x(b); });
    
  svg.selectAll('circle')
    //.delay(delay)
    .attr('cx', function (d) { 
      q = d3.select(this).attr('class');
      return x(q) || 0; 
    });
  //svg.selectAll('g.line').remove();

  transition.selectAll('.dimension')
    .delay(delay)
    .attr('transform', function(d) { return 'translate(' + x(d) + ')'; });
}

// Returns the path for a given data point.
function path(d) {
  return line(dimensions.map(function(p) { return [x(p), y[p](d[p])]; }));
}
// Returns an array of coordinates for plotting points 
function points(d) {
  return dimensions.map(function(p) { return [x(p), y[p](d[p])]; });
}

// Typeahead string matching functionality
// This will be replaced by new SOURCE and MATCHER functions
// Takes object array of courses
// returns object array of match
var substringMatcher = function(strs) {
  return function findMatches(q, cb) {
    var matches, substrRegex;
 
    // an array that will be populated with substring matches
    matches = [];
 
    // regex used to determine if a string contains the substring `q`
    substrRegex = new RegExp(q, 'i');
 
    // iterate through the pool of strings and for any string that
    // contains the substring `q`, add it to the `matches` array
    $.each(strs, function(i, str) {
      if (substrRegex.test(str)) {
        // the typeahead jQuery plugin expects suggestions to a
        // JavaScript object, refer to typeahead docs for more info
        matches.push({ value: str });
      }
    });
 
    cb(matches);
  };
};

</script>
</html>