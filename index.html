<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>Course Comparison Tool</title>
   
    <!-- Bootstrap Styling -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap.min.css">

    <!-- Custom Styling -->
    <link rel="stylesheet" href="css/main.css">

    <!-- JavaScript for D3 and Bootstrap -->
    <script src="http://d3js.org/d3.v3.min.js"></script>
    <script src="http://d3js.org/queue.v1.min.js"></script>
    <script src="https://code.jquery.com/jquery-2.1.3.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/js/bootstrap.min.js"></script>
  </head>
  <body>
    <nav class="navbar navbar-default">
      <div class="container-fluid">
        <div class="navbar-header">
          <a class="navbar-brand">Course Comparison Tool</a>
        </div>
        <div class="collapse navbar-collapse">
          <p class="navbar-text navbar-right">By Anu, Jill, and Mike</p>
        </div>
      </div>
    </nav>
    <div class="container">
      <div class="row">
        <div class="col-md-3 col-md-offset-1">
          <select class="form-control class-1">
            <option value='-1'>Choose a course</option>
          </select>
        </div>
        <div class="col-md-3">
          <select class="form-control class-2">
          <option value='-1'>Choose a course</option>
          </select>
        </div>
        <div class="col-md-3">
          <select class="form-control class-3">
          <option value='-1'>Choose a course</option>
          </select>
        </div>
      </div>
      <div id="optionSort">
        <input name="updateButton" type="button" value="Sort Features" />
      </div>
    </div>
    <div class="container graph">
    </div>
  </body>
  <script>

// Graph size and coordinates
var margin = {top: 90, right: 10, bottom: 10, left: 150},
    width = 960 - margin.left - margin.right,
    height = 500 - margin.top - margin.bottom;

var x = d3.scale.ordinal().rangePoints([0, width], 1),
    y = {};

var line = d3.svg.line(),
    axis = d3.svg.axis().orient('left');

// Selected class colors: red, blue, green
var colors = ['#e41a1c', '#377eb8', '#4daf4a'];

var likertTicks = ['very poor', 'poor', 'fair', 'good', 'very good', 'excellent'];

// Main svg container for graph
var svg = d3.select('.graph').append('svg')
    .attr('width', width + margin.left + margin.right)
    .attr('height', height + margin.top + margin.bottom)
  .append('g')
    .attr('transform', 'translate(' + margin.left + ',' + margin.top + ')');

// Separate yAxis on left to show Likert ratings
var yAxis = d3.svg.axis()
  .scale(
    d3.scale.linear()
      .range([height, 0]))
  .orient('left')
  .ticks(likertTicks.length)
  .tickFormat(function(_, i) { return likertTicks[i]; });
 
// Hover tooltip to show class name
var tooltip = d3.select('body')
  .append('div')
  .style('position', 'absolute')
  .style('z-index', '10')
  .style('visibility', 'hidden');

// Dropdown selectors: Used to grab class selection values
var classSelector = [];
classSelector[0] = d3.selectAll('select'); // All dropdown selectors
classSelector[1] = d3.select('select.class-1'); // Class 1
classSelector[2] = d3.select('select.class-2'); // Class 2
classSelector[3] = d3.select('select.class-3'); // Class 3

// Load the data files
queue()
  .defer(d3.csv, 'data/some_courses.csv')
  .defer(d3.json, 'data/eval_questions.json')
  .await(ready);

// Main sequence
function ready(error, courses, eval_questions) {
  // Extract the list of dimensions and create a scale for each.
  var features = d3.keys(courses[0]).filter(function(d) {
    // Exclude these features from the graph
    nonfeatures = ['crsabbr','crsno','fname','lname','formtype', 
                   'q23','q24','q25','q26','q27','q28','q29','q30','q31','q32'];
    return nonfeatures.indexOf(d) < 0 && 
      (y[d] = d3.scale.linear()
        .domain([0,5])
        .range([height, 0]));
  });

  x.domain(dimensions = features);

  // console.log(courses);
  // console.log(eval_questions);

  // Assign behavior to all dropdown selectors at once
  classSelector[0]
    .on('change', function(d) {
      var value = d3.select(this).property('value');
      // Which class selector changed? 1-3
      var selectionNum = d3.select(this).attr('class').match(/\d+/)[0];
      // Update that particular line
      updateLine(courses, selectionNum);
    });
  classSelector[0].selectAll('option')
    .data(courses)
    .enter()
      .append('option')
      .attr('value', function (d, i) { return i; })
      .text(function (d) { return d.crsabbr + ' ' + d.crsno + ' ' + d.lname; });

  // Insert the yAxis
  svg.append('g')
    .attr("class", "y axis")
    .attr('transform', 'translate(-15,0)')
    .call(yAxis);

  // Add a group element for each dimension (eval question).
  var g = svg.selectAll('.dimension')
      .data(dimensions)
    .enter().append('g')
      .attr('class', 'dimension')
      .attr('transform', function(d) { return 'translate(' + x(d) + ')'; });

  // Add an axis and title.
  g.append('g')
      .attr('class', 'axis feature-column')
      .each(function(d) { 
        that = d3.select(this);
        d3.select(this).call(axis.scale(y[d]));
        // No labels on columns
        that.call(axis.ticks(0));
        that.call(axis.tickFormat(''));
      })
    .append('text')
      .style('text-anchor', 'left')
      .attr('class','labels')
      .attr('x', 10)
      .attr('y', -10)
      .attr('transform', function(d) {
         return 'rotate(-45)'; 
      })
      .text(function(d, i) {
        return eval_questions[i].tag; 
      });

  // Format axis labels for likert ratings
  svg.selectAll('g.tick text')
    .attr('class','labels-ratings')
    .attr('x', -10);

  // Add group for each possible selection
  svg.selectAll('g.line')
    // Slice off first array item since it is the group of classes
    .data(classSelector.slice(1))
    .enter().append('g')
      .attr('class', function(d,i) { return 'line class-' + (i+1); })
    // Add an empty path that will be updated later
    .append('path');

  // Add empty circles that will be updated later
  svg.selectAll('g.line').each(function(d) {
    d3.select(this).selectAll('circle')
      .data(x.domain())
      .enter().append('circle');
    });

  d3.select('#optionSort')
    .on('click', function(_) { change(courses[1], features); });
}

// Called whenever a dropdown class selection changes
function updateLine(courses, selectionNum) {
  // Which class was selected by which dropdown selector?
  var newClassIndex = +classSelector[selectionNum].node().value;
  var newClass = courses[newClassIndex];

  var lineGroup = svg.selectAll('g.class-' + selectionNum);

  // Update the line path
  lineGroup.selectAll('path')
    .data([newClass])
    .attr('d', path)
    .attr('stroke', function(d, i) { return colors[i]; })
    .on('mouseover', function(d){
      return tooltip
        .style('visibility', 'visible')
        .text(d.crsabbr + ' ' + d.crsno + ' ' + d.lname);
      })
    .on('mousemove', function(){
      return tooltip
        .style('top', (event.pageY-10)+'px').style('left',(event.pageX+10)+'px');
      })
    .on('mouseout', function(){
      return tooltip
        .style('visibility', 'hidden');
      });

  // Update the circles
  var circleCoords = points(newClass);
  lineGroup.selectAll('circle')
    .data(circleCoords)
    .attr('fill', function(_, i) { return colors[i]; })
    .attr('cx', function (d) { return d[0]; })
    .attr('cy', function (d) { return d[1]; })
    .attr('r', 5); 
}

// Sort the feature columns by value (Not working yet)
function change(course, features) {
    console.log(course);
    console.log(features);
    // Copy-on-write since tweens are evaluated after a delay.
    var x0 = x.domain(features.sort(function(a, b) { return course[b] - course[a]; }))
      //.map(function(d) { return d; })
      .copy();
    console.log(x0);
    //console.log(features.sort(function(a, b) { return course[b] - course[a]; }));
    svg.selectAll('.circle')
      .sort(function(a, b) { return x0(a) - x0(b); })
      .attr('x', function(d) { return x0(d); });

    var transition = svg.transition().duration(750),
        delay = function(d, i) { return i * 50; };

    // transition.selectAll('.bar')
    //     .delay(delay)
    //     .attr("x", function(d) { return x0(d.letter); });

    transition.selectAll('.feature-column')
      .call(axis.scale(dimensions))
      .delay(delay);
  }

// Returns the path for a given data point.
function path(d) {
  return line(dimensions.map(function(p) { return [x(p), y[p](d[p])]; }));
}
// Returns an array of coordinates for plotting points 
function points(d) {
  return dimensions.map(function(p) { return [x(p), y[p](d[p])]; });
}

function position(d) {
  var v = dragging[d];
  return v === null ? x(d) : v;
}

function transition(g) {
  return g.transition().duration(500);
}

</script>
</html>